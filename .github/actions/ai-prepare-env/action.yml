---

name: ai-prepare-env
description: Prepare the environment for AI-related tasks (requires checkout to be done first)

# Prepares the environment for ai agents.

runs:
  using: composite
  steps:
    - name: 'Setup Go'
      uses: actions/setup-go@v5
      with:
        go-version-file: 'go.mod'
        cache: true
        cache-dependency-path: |
          **/go.sum
          **/go.mod
    # -----
    - name: 'Download Go modules'
      run: go mod tidy && go mod download
      shell: bash
    # -----
    - name: 'Install protoc plugins for buf'
      run: |
        go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
        go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
      shell: bash
    # -----
    - name: 'Cache Homebrew and formulae'
      uses: actions/cache@v4
      with:
        path: |
          /home/linuxbrew/.linuxbrew
          /home/linuxbrew/.cache/Homebrew
        key: homebrew-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('Makefile') }}
        restore-keys: |
          homebrew-${{ runner.os }}-${{ runner.arch }}-
          homebrew-${{ runner.os }}-
    # -----
    - name: 'Setup Homebrew'
      uses: Homebrew/actions/setup-homebrew@main
    # -----
    - name: 'Setup project dependencies'
      run: make setup
      shell: bash
    # -----
    - name: 'Setup MCP servers'
      run: make setup-mcp
      shell: bash
    # -----
    - name: 'Generate ai agent environment'
      env:
        CI: true
        GITHUB_ACTOR: ${{ github.actor }}
        GITHUB_REPOSITORY: ${{ github.repository }}
        GITHUB_EVENT_NAME: ${{ github.event_name }}
        GITHUB_EVENT_PAYLOAD: ${{ toJSON(github.event) }}
        GITHUB_HEAD_REF: ${{ github.head_ref }}
        GITHUB_REF_NAME: ${{ github.ref_name }}
        GITHUB_SHA: ${{ github.sha }}
        GITHUB_SERVER_URL: ${{ github.server_url }}
        GITHUB_RUN_ID: ${{ github.run_id }}
      run: make generate-ai
      shell: bash
