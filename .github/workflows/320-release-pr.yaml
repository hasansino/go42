name: release-pr

# Creates a PR to update the appVersion in the Chart.yaml file.
# This PR will also generate a release summary using OpenAI API.
# @note merging this PR will trigger deployment.

on:
  workflow_call: 
    inputs:
      runs_on:
        required: true
        type: string
      continue_on_error:
        required: true
        type: boolean
      tag:
        required: true
        type: string
      llm_model:
        required: true
        type: string
      llm_summary:
        required: true
        type: boolean
      debug:
        required: false
        type: boolean

permissions: {}

jobs:
  prepare-release:
    name: prepare-release
    runs-on: ${{ inputs.runs_on }}
    continue-on-error: ${{ inputs.continue_on_error }}
    outputs:
      previous_tag: ${{ steps.prev_tag.outputs.previous_tag }}
      comparison_url: ${{ steps.prev_tag.outputs.comparison_url }}
    permissions:
      contents: write
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get previous tag and comparison URL
        id: prev_tag
        run: |
          PREVIOUS_TAG="$(git describe --abbrev=0 --tags "$(git rev-list --tags --skip=1 --max-count=1)" 2>/dev/null || echo "")"
          if [ -z "$PREVIOUS_TAG" ]; then
            echo "previous_tag=" >> "$GITHUB_OUTPUT"
            echo "comparison_url=" >> "$GITHUB_OUTPUT"
          else
            echo "previous_tag=$PREVIOUS_TAG" >> "$GITHUB_OUTPUT"
            echo "comparison_url=https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          fi
      - name: Update Helm Chart appVersion
        run: |
          sed -i "s/^appVersion:.*/appVersion: \"${{ inputs.tag }}\"/" infra/helm/app/Chart.yaml
      - name: Upload modified files
        uses: actions/upload-artifact@v4
        with:
          name: release-files
          path: infra/helm/app/Chart.yaml
          
  generate-summary:
    name: Generate Release Summary
    needs: prepare-release
    if: inputs.llm_summary && needs.prepare-release.outputs.previous_tag != ''
    uses: ./.github/workflows/generate-summary.yaml
    with:
      base_ref: ${{ needs.prepare-release.outputs.previous_tag }}
      head_ref: ${{ inputs.tag }}
      context_type: release
      llm_model: ${{ inputs.llm_model }}
      debug: ${{ inputs.debug }}
    secrets:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      
  create-pr:
    name: Create Release PR
    runs-on: ${{ inputs.runs_on }}
    needs: [prepare-release, generate-summary]
    if: always() && needs.prepare-release.result == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Download modified files
        uses: actions/download-artifact@v4
        with:
          name: release-files
          path: infra/helm/app/
      - name: Create pull request for release
        uses: peter-evans/create-pull-request@v7
        with:
          commit-message: "auto-release-${{ inputs.tag }}"
          title: "Release ${{ inputs.tag }}"
          body: |
            This is an automated release PR. Merging this PR will trigger a deployment.
            
            ${{ needs.prepare-release.outputs.previous_tag && format('**Previous version:** `{0}`', needs.prepare-release.outputs.previous_tag) || '' }}
            ${{ needs.prepare-release.outputs.comparison_url && format('**Full changelog:** {0}', needs.prepare-release.outputs.comparison_url) || '' }}
            
            ---
            
            ${{ needs.generate-summary.outputs.summary || '## Release Summary\n\nNo automated summary available. Please review the changelog link above.' }}
          branch: "auto-release-${{ inputs.tag }}"
          delete-branch: true
          branch-suffix: random
          sign-commits: true
          base: master
          assignees: ${{ github.actor }} # will be whoever created a tag