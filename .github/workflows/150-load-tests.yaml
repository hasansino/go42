name: load-tests

# Load tests.
# Simulates load on application and records statistics.
# When this workflow is triggered in pull request, it will post statistics to pull request.

on:
  workflow_dispatch:
    inputs:
      runs_on:
        required: true
        type: string
        default: ubuntu-latest
        description: "runs_on"
      continue_on_error:
        required: true
        type: boolean
        default: false
        description: "continue_on_error"
      service_name:
        required: true
        type: string
        default: "go42"
        description: "service_name"
      image_tag:
        required: true
        type: string
        default: "tmp"
        description: "image_tag"
      database_engine:
        required: false
        type: string
        default: ""
        description: "database_engine (leave empty to test all)"
  workflow_call:
    inputs:
      runs_on:
        required: true
        type: string
      continue_on_error:
        required: true
        type: boolean
      service_name:
        required: true
        type: string
      image_tag:
        required: true
        type: string
      database_engine:
        required: false
        type: string
        default: ""

permissions: {}

jobs:
  report:
    name: report
    runs-on: ${{ inputs.runs_on }}
    needs: load-tests
    if: always()
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: k6-summary-*
          merge-multiple: true
      - uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read all k6 summary files
            const files = fs.readdirSync('.').filter(f => f.startsWith('k6-summary-') && f.endsWith('.json'));
            
            let allResults = [];
            
            for (const file of files) {
              const match = file.match(/k6-summary-(\w+)-(\w+)-v1\.json/);
              if (!match) continue;
              
              const [_, protocol, database] = match;
              const results = JSON.parse(fs.readFileSync(file, 'utf8'));
              
              allResults.push({ protocol, database, results });
            }
            
            // Sort results for consistent output
            allResults.sort((a, b) => {
              if (a.protocol !== b.protocol) return a.protocol.localeCompare(b.protocol);
              return a.database.localeCompare(b.database);
            });
            
            // Generate GitHub Job Summary
            let summary = '# ðŸš€ Load Test Results Summary\n\n';
            
            // Create a summary table
            summary += '| Protocol | Database | VUs Max | Total Requests | Avg Response | P95 Response | Success Rate |\n';
            summary += '|----------|----------|---------|----------------|--------------|--------------|-------------|\n';
            
            for (const { protocol, database, results } of allResults) {
              if (protocol === 'http') {
                const vusMax = results.metrics.vus_max?.value || 'N/A';
                const httpReqsCount = results.metrics.http_reqs?.count || 0;
                const httpReqsRate = results.metrics.http_reqs?.rate || 0;
                const httpReqDurationAvg = results.metrics.http_req_duration?.avg || 0;
                const httpReqDurationP95 = results.metrics.http_req_duration?.['p(95)'] || 0;
                const checksPasses = results.metrics.checks?.passes || 0;
                const checksFails = results.metrics.checks?.fails || 0;
                const totalChecks = checksPasses + checksFails;
                const successRate = totalChecks > 0 ? (checksPasses / totalChecks * 100) : 0;
                
                summary += `| HTTP | ${database} | ${vusMax} | ${httpReqsCount} (${httpReqsRate.toFixed(2)}/s) | ${httpReqDurationAvg.toFixed(2)}ms | ${httpReqDurationP95.toFixed(2)}ms | ${successRate.toFixed(2)}% |\n`;
              } else if (protocol === 'grpc') {
                const vusMax = results.metrics.vus_max?.value || 'N/A';
                const iterationsCount = results.metrics.iterations?.count || 0;
                const iterationsRate = results.metrics.iterations?.rate || 0;
                const grpcReqDurationAvg = results.metrics.grpc_req_duration?.avg || 0;
                const grpcReqDurationP95 = results.metrics.grpc_req_duration?.['p(95)'] || 0;
                const checksPasses = results.metrics.checks?.passes || 0;
                const checksFails = results.metrics.checks?.fails || 0;
                const totalChecks = checksPasses + checksFails;
                const successRate = totalChecks > 0 ? (checksPasses / totalChecks * 100) : 0;
                
                summary += `| gRPC | ${database} | ${vusMax} | ${iterationsCount} (${iterationsRate.toFixed(2)}/s) | ${(grpcReqDurationAvg * 1000).toFixed(2)}ms | ${(grpcReqDurationP95 * 1000).toFixed(2)}ms | ${successRate.toFixed(2)}% |\n`;
              }
            }
            
            // Add detailed breakdowns
            summary += '\n## ðŸ“Š Detailed Results\n\n';
            
            for (const { protocol, database, results } of allResults) {
              summary += `<details>\n<summary><b>${protocol.toUpperCase()} - ${database}</b></summary>\n\n`;
              
              if (protocol === 'http') {
                const vusMax = results.metrics.vus_max?.value || 'N/A';
                const vusMin = results.metrics.vus?.min || 0;
                const vusMaxRange = results.metrics.vus?.max || 0;
                const httpReqsCount = results.metrics.http_reqs?.count || 0;
                const httpReqsRate = results.metrics.http_reqs?.rate || 0;
                const httpReqDurationAvg = results.metrics.http_req_duration?.avg || 0;
                const httpReqDurationMed = results.metrics.http_req_duration?.med || 0;
                const httpReqDurationMin = results.metrics.http_req_duration?.min || 0;
                const httpReqDurationMax = results.metrics.http_req_duration?.max || 0;
                const httpReqDurationP90 = results.metrics.http_req_duration?.['p(90)'] || 0;
                const httpReqDurationP95 = results.metrics.http_req_duration?.['p(95)'] || 0;
                const httpReqFailedPasses = results.metrics.http_req_failed?.passes || 0;
                const httpReqFailedValue = results.metrics.http_req_failed?.value || 0;
                const checksPasses = results.metrics.checks?.passes || 0;
                const checksFails = results.metrics.checks?.fails || 0;
                
                summary += '**Virtual Users**\n';
                summary += `- Maximum: ${vusMax}\n`;
                summary += `- Range: ${vusMin} - ${vusMaxRange}\n\n`;
                
                summary += '**Requests**\n';
                summary += `- Total: ${httpReqsCount}\n`;
                summary += `- Rate: ${httpReqsRate.toFixed(2)}/sec\n`;
                summary += `- Failed: ${httpReqFailedPasses} (${(httpReqFailedValue * 100).toFixed(2)}%)\n\n`;
                
                summary += '**Response Times**\n';
                summary += `- Min: ${httpReqDurationMin.toFixed(2)}ms\n`;
                summary += `- Median: ${httpReqDurationMed.toFixed(2)}ms\n`;
                summary += `- Average: ${httpReqDurationAvg.toFixed(2)}ms\n`;
                summary += `- P90: ${httpReqDurationP90.toFixed(2)}ms\n`;
                summary += `- P95: ${httpReqDurationP95.toFixed(2)}ms\n`;
                summary += `- Max: ${httpReqDurationMax.toFixed(2)}ms\n\n`;
                
                summary += '**Checks**\n';
                summary += `- Passed: ${checksPasses}\n`;
                summary += `- Failed: ${checksFails}\n`;
              } else if (protocol === 'grpc') {
                const vusMax = results.metrics.vus_max?.value || 'N/A';
                const vusMin = results.metrics.vus?.min || 0;
                const vusMaxRange = results.metrics.vus?.max || 0;
                const iterationsCount = results.metrics.iterations?.count || 0;
                const iterationsRate = results.metrics.iterations?.rate || 0;
                const grpcReqDurationAvg = results.metrics.grpc_req_duration?.avg || 0;
                const grpcReqDurationMed = results.metrics.grpc_req_duration?.med || 0;
                const grpcReqDurationMin = results.metrics.grpc_req_duration?.min || 0;
                const grpcReqDurationMax = results.metrics.grpc_req_duration?.max || 0;
                const grpcReqDurationP90 = results.metrics.grpc_req_duration?.['p(90)'] || 0;
                const grpcReqDurationP95 = results.metrics.grpc_req_duration?.['p(95)'] || 0;
                const checksPasses = results.metrics.checks?.passes || 0;
                const checksFails = results.metrics.checks?.fails || 0;
                
                summary += '**Virtual Users**\n';
                summary += `- Maximum: ${vusMax}\n`;
                summary += `- Range: ${vusMin} - ${vusMaxRange}\n\n`;
                
                summary += '**Requests**\n';
                summary += `- Total: ${iterationsCount}\n`;
                summary += `- Rate: ${iterationsRate.toFixed(2)}/sec\n\n`;
                
                summary += '**Response Times**\n';
                summary += `- Min: ${(grpcReqDurationMin * 1000).toFixed(2)}ms\n`;
                summary += `- Median: ${(grpcReqDurationMed * 1000).toFixed(2)}ms\n`;
                summary += `- Average: ${(grpcReqDurationAvg * 1000).toFixed(2)}ms\n`;
                summary += `- P90: ${(grpcReqDurationP90 * 1000).toFixed(2)}ms\n`;
                summary += `- P95: ${(grpcReqDurationP95 * 1000).toFixed(2)}ms\n`;
                summary += `- Max: ${(grpcReqDurationMax * 1000).toFixed(2)}ms\n\n`;
                
                summary += '**Checks**\n';
                summary += `- Passed: ${checksPasses}\n`;
                summary += `- Failed: ${checksFails}\n`;
              }
              
              summary += '\n</details>\n\n';
            }
            
            // Write to GitHub Step Summary
            await core.summary
              .addRaw(summary)
              .write();
  load-tests:
    name: load-tests-${{ matrix.protocol }}-${{ matrix.database }}
    runs-on: ${{ inputs.runs_on }}
    continue-on-error: ${{ inputs.continue_on_error }}
    permissions:
      packages: read
      pull-requests: write
      issues: write
    strategy:
      matrix:
        protocol: [http, grpc]
        database: [sqlite, mysql, pgsql]
        include:
          # HTTP configurations
          - protocol: http
            database: sqlite
            database_engine: sqlite
            app_port: 44441
            grpc_port: 55551
            test_path: ./tests/load/http/v1/auth_test.js
            env_name: ci-load-tests-http
            server_address_env: HTTP_SERVER_ADDRESS
            grpc_auth_enabled: true
          - protocol: http
            database: mysql
            database_engine: mysql
            app_port: 44442
            grpc_port: 55552
            test_path: ./tests/load/http/v1/auth_test.js
            env_name: ci-load-tests-http
            server_address_env: HTTP_SERVER_ADDRESS
            grpc_auth_enabled: true
          - protocol: http
            database: pgsql
            database_engine: pgsql
            app_port: 44443
            grpc_port: 55553
            test_path: ./tests/load/http/v1/auth_test.js
            env_name: ci-load-tests-http
            server_address_env: HTTP_SERVER_ADDRESS
            grpc_auth_enabled: true
          # GRPC configurations
          - protocol: grpc
            database: sqlite
            database_engine: sqlite
            app_port: 44444
            grpc_port: 55554
            test_path: ./tests/load/grpc/v1/auth_test.js
            env_name: ci-load-tests
            server_address_env: GRPC_SERVER_ADDRESS
            grpc_auth_enabled: false
          - protocol: grpc
            database: mysql
            database_engine: mysql
            app_port: 44445
            grpc_port: 55555
            test_path: ./tests/load/grpc/v1/auth_test.js
            env_name: ci-load-tests
            server_address_env: GRPC_SERVER_ADDRESS
            grpc_auth_enabled: false
          - protocol: grpc
            database: pgsql
            database_engine: pgsql
            app_port: 44446
            grpc_port: 55556
            test_path: ./tests/load/grpc/v1/auth_test.js
            env_name: ci-load-tests
            server_address_env: GRPC_SERVER_ADDRESS
            grpc_auth_enabled: false
        exclude:
          # Exclude combinations if specific database_engine is requested
          - database: ${{ inputs.database_engine != '' && inputs.database_engine != 'sqlite' && 'sqlite' || '' }}
          - database: ${{ inputs.database_engine != '' && inputs.database_engine != 'mysql' && 'mysql' || '' }}
          - database: ${{ inputs.database_engine != '' && inputs.database_engine != 'pgsql' && 'pgsql' || '' }}
    services:
      mysql:
        image: ${{ matrix.database == 'mysql' && 'mysql:latest' || '' }}
        ports:
          - 3306:3306
        env:
          MYSQL_USER: user
          MYSQL_PASSWORD: qwerty
          MYSQL_DATABASE: go42
          MYSQL_ROOT_PASSWORD: qwerty
        options: >-
          --health-cmd "mysql -h localhost -u user -pqwerty -D go42 -e 'SELECT 1' || exit 1"
          --health-start-period 30s
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
      pgsql:
        image: ${{ matrix.database == 'pgsql' && 'postgres:latest' || '' }}
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: user
          POSTGRES_PASSWORD: qwerty
          POSTGRES_DB: go42
        options: >-
          --health-cmd "PGPASSWORD=qwerty psql -h localhost -U user -d go42 -c 'SELECT 1' || exit 1"
          --health-start-period 10s
          --health-interval 5s
          --health-timeout 5s
          --health-retries 5
      app:
        image: ghcr.io/${{ github.repository_owner }}/${{ inputs.service_name }}:${{ inputs.image_tag }}
        ports:
          - ${{ matrix.app_port }}:8080  # unique ports to avoid conflicts on self-hosted runners
          - ${{ matrix.grpc_port }}:50051 # unique ports to avoid conflicts on self-hosted runners
        env:
          LOG_LEVEL: warn
          ENVIRONMENT: ${{ matrix.env_name }}
          SERVER_HTTP_LISTEN: :8080
          SERVER_GRPC_LISTEN: :50051
          SERVER_GRPC_AUTHORIZATION_ENABLED: ${{ matrix.grpc_auth_enabled }}
          DATABASE_ENGINE: ${{ matrix.database_engine }}
          DATABASE_MYSQL_MASTER_HOST: mysql
          DATABASE_MYSQL_SLAVE_HOST: mysql
          DATABASE_PGSQL_MASTER_HOST: pgsql
          DATABASE_PGSQL_SLAVE_HOST: pgsql
        options: >-
          --health-cmd "curl -f http://localhost:8080/health || exit 1"
          --health-start-period 1s
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4
      - uses: grafana/setup-k6-action@v1
      - uses: grafana/run-k6-action@v1
        with:
          path: ${{ matrix.test_path }}
          flags: --summary-export=k6-summary-${{ matrix.protocol }}-${{ matrix.database }}-v1.json
        env:
          ${{ matrix.server_address_env }}: ${{ matrix.protocol == 'http' && format('http://localhost:{0}', matrix.app_port) || format('localhost:{0}', matrix.grpc_port) }}
      - uses: actions/upload-artifact@v4
        with:
          name: k6-summary-${{ matrix.protocol }}-${{ matrix.database }}-v1
          path: k6-summary-${{ matrix.protocol }}-${{ matrix.database }}-v1.json
