name: release-pr-merge

# After auto-release pull request is merged, create release and delete branch.

on:
  pull_request:
    types: [closed]

permissions: {}

jobs:
  release-pr-merge:
    if: |
      github.event.pull_request.merged == true && 
      startsWith(github.event.pull_request.title, 'Release') &&
      github.event.pull_request.user.login == 'github-actions[bot]'
    name: release-pr-merge
    runs-on: ubuntu-latest
    continue-on-error: false
    permissions:
      contents: write
    # ----
    steps:
      - name: Checkout repository with full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: extract_semver
        name: Extract version from PR title
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          VERSION=$(echo "$PR_TITLE" | grep -oP '\d+\.\d+\.\d+' | head -n 1)
          if [ -z "$VERSION" ]; then
            echo "Error: No valid semver version found in PR title"
            exit 1
          fi
          echo "version=v$VERSION" >> "$GITHUB_OUTPUT"

      # create release
      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          name: Release ${{ steps.extract_semver.outputs.version }}
          tag_name: ${{ steps.extract_semver.outputs.version }}
          generate_release_notes: true

      # remove branch after merge
      - name: Delete PR branch after merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.event.pull_request.head.ref }}
          REPOSITORY: ${{ github.repository }}
        run: |
          gh api -X DELETE "repos/${REPOSITORY}/git/refs/heads/${BRANCH_NAME}"
