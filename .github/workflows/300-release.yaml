name: release

# Release.
# Triggered by v{semver} tag push.

on:
  workflow_dispatch:
  push:
    tags: [ 'v*' ]

permissions:
  contents: write
  packages: write
  attestations: write
  id-token: write
  pull-requests: write
  actions: read
  models: read

jobs:
  docker-build:
    name: docker-build
    uses: ./.github/workflows/140-docker-build.yaml
    with:
      runs_on: ubuntu-latest
      continue_on_error: false
      service_name: "go42"
      image_tag: ${{ github.ref_name }}
      platforms: "linux/amd64,linux/arm64"
      attestation: true
      generate_sbom: true
      attestation_sbom: true

  generate-summary:
    name: generate-summary
    needs: [ docker-build ]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      models: read
    outputs:
      summary: ${{ steps.ai_summary.outputs.summary }}
      previous_tag: ${{ steps.prev_tag.outputs.previous_tag }}
    env:
      SUMMARY_ENABLE: ${{ vars.SUMMARY_ENABLE }}
      SUMMARY_MODEL: ${{ vars.SUMMARY_MODEL }}
    steps:
      - name: 'Checkout repository with full history'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # ----
      - name: 'Get previous tag'
        id: prev_tag
        run: |
          PREVIOUS_TAG="$(git tag --sort=-version:refname | head -2 | tail -1 2>/dev/null || echo "")"
          echo "previous_tag=$PREVIOUS_TAG" >> "$GITHUB_OUTPUT"
      # ----
      - name: 'Generate AI Summary'
        id: ai_summary
        uses: ./.github/actions/ai-generate-summary
        with:
          base_ref: ${{ steps.prev_tag.outputs.previous_tag }}
          head_ref: ${{ github.ref_name }}
          context_type: release
          github_token: ${{ secrets.GITHUB_TOKEN }}

  create-pr:
    name: create-pr
    runs-on: ubuntu-latest
    needs: [docker-build, generate-summary]
    if: always() && needs.docker-build.result == 'success'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 'Generate GitHub App Token'
        id: generate_token
        if: ${{ vars.RELEASE_APP_ID }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.RELEASE_APP_ID }}
          private-key: ${{ secrets.RELEASE_APP_PRIVATE_KEY }}
      # ----
      - name: 'Checkout repository with full history'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      # ----
      - name: 'Update Helm Chart appVersion'
        run: |
          sed -i "s/^appVersion:.*/appVersion: \"${{ github.ref_name }}\"/" infra/helm/app/Chart.yaml
      # ----
      - name: 'Create pull request for release'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.generate_token.outputs.token || secrets.GITHUB_TOKEN }}
          commit-message: "auto-release-${{ github.ref_name }}"
          title: "Release ${{ github.ref_name }}"
          body: |
            This is an automated release PR. Merging this PR will trigger a deployment.
            
            ${{ needs.generate-summary.outputs.previous_tag && format('**Previous version:** `{0}`', needs.generate-summary.outputs.previous_tag) || '' }}
            ${{ needs.generate-summary.outputs.previous_tag && format('**Full changelog:** https://github.com/{0}/compare/{1}...{2}', github.repository, needs.generate-summary.outputs.previous_tag, github.ref_name) || '' }}
            
            ---
            
            ${{ needs.generate-summary.outputs.summary || '## Release Summary\n\nNo automated summary available. Please review the changelog link above.' }}
          branch: "auto-release-${{ github.ref_name }}"
          delete-branch: true
          branch-suffix: random
          sign-commits: true
          base: master
          assignees: ${{ github.actor }} # will be whoever created a tag
