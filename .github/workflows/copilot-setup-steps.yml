name: copilot-setup-steps

# This workflow is responsible for setting up the environment for Copilot.
# File MUST be named `copilot-setup-steps.yml`.
# IMPORTANT: This file must contain steps, not jobs, as GitHub Copilot
# will inline these steps into its dynamically generated workflow.

on:
  workflow_dispatch:

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # -----
      - uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true
          cache-dependency-path: |
            **/go.sum
            **/go.mod
      # -----
      - run: go mod tidy && go mod download
      # -----
      - name: Cache Homebrew and formulae
        uses: actions/cache@v4
        with:
          path: |
            /home/linuxbrew/.linuxbrew
            /home/linuxbrew/.cache/Homebrew
          key: homebrew-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('Makefile') }}
          restore-keys: |
            homebrew-${{ runner.os }}-${{ runner.arch }}-
            homebrew-${{ runner.os }}-
      # -----
      - uses: Homebrew/actions/setup-homebrew@main
      # -----
      - run: make setup
      # -----
      - name: Set CI environment variables for genai
        env:
          HEAD_REF: ${{ github.head_ref }}
          REF_NAME: ${{ github.ref_name }}
          PR_HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          SHA: ${{ github.sha }}
          SERVER_URL: ${{ github.server_url }}
          REPOSITORY: ${{ github.repository }}
          RUN_ID: ${{ github.run_id }}
          EVENT_NAME: ${{ github.event_name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_BASE_REF: ${{ github.event.pull_request.base.ref }}
        run: |
          {
            echo "CI=true"
            echo "BRANCH=${HEAD_REF:-$REF_NAME}"
            echo "COMMIT_SHA=${PR_HEAD_SHA:-$SHA}"
            echo "BUILD_URL=${SERVER_URL}/${REPOSITORY}/actions/runs/${RUN_ID}"
            
            # PR-specific variables
            if [ "$EVENT_NAME" = "pull_request" ] || [ "$EVENT_NAME" = "pull_request_review" ] || [ "$EVENT_NAME" = "pull_request_review_comment" ]; then
              echo "PR_NUMBER=${PR_NUMBER:-$ISSUE_NUMBER}"
              echo "TARGET_BRANCH=${PR_BASE_REF:-master}"
            else
              echo "PR_NUMBER="
              echo "TARGET_BRANCH=main"
            fi
          } >> "$GITHUB_ENV"
      # -----
      - run: make generate-ai
