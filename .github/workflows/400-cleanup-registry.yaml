name: cleanup-registry

# Cleanup GitHub Container Registry.
# Deletes old Docker images based on retention policy.
# Runs on schedule and can be triggered manually.

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    inputs:
      retention_days:
        description: 'Number of days to retain images'
        required: false
        type: number
        default: 30
      dry_run:
        description: 'Perform dry run (no deletions)'
        required: false
        type: boolean
        default: false

env:
  SERVICE_NAME: go42
  DEFAULT_RETENTION_DAYS: 30

permissions: {}

jobs:
  cleanup-registry:
    name: cleanup-registry
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Set retention period
        id: config
        run: |
          if [ "${{ github.event_name }}" = "schedule" ]; then
            {
              echo "retention_days=${{ env.DEFAULT_RETENTION_DAYS }}"
              echo "dry_run=false"
            } >> "$GITHUB_OUTPUT"
          else
            {
              echo "retention_days=${{ inputs.retention_days }}"
              echo "dry_run=${{ inputs.dry_run }}"
            } >> "$GITHUB_OUTPUT"
          fi
      
      - name: Cleanup old images
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OWNER: ${{ github.repository_owner }}
          PACKAGE_NAME: ${{ env.SERVICE_NAME }}
          RETENTION_DAYS: ${{ steps.config.outputs.retention_days }}
          DRY_RUN: ${{ steps.config.outputs.dry_run }}
        run: |
          echo "Starting registry cleanup for $PACKAGE_NAME..."
          echo "Repository: ghcr.io/$OWNER/$PACKAGE_NAME"
          echo "Retention period: $RETENTION_DAYS days"
          echo "Dry run: $DRY_RUN"
          
          # Calculate cutoff date
          if [ "$(uname)" = "Darwin" ]; then
            CUTOFF_DATE=$(date -u -v-"${RETENTION_DAYS}"d +"%Y-%m-%dT%H:%M:%SZ")
          else
            CUTOFF_DATE=$(date -u -d "$RETENTION_DAYS days ago" +"%Y-%m-%dT%H:%M:%SZ")
          fi
          echo "Cutoff date: $CUTOFF_DATE"
          
          # Process the package
          total_deleted=0
          total_size_saved=0
          
          echo ""
          echo "Processing package: $PACKAGE_NAME"
          
          # Fetch all versions
          page=1
          all_versions=""
          
          while true; do
            # Try org endpoint first, then user endpoint
            response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions?per_page=100&page=$page")
            
            http_code=$(echo "$response" | tail -n1)
            
            # If org endpoint fails with 404, try user endpoint
            if [ "$http_code" = "404" ]; then
              response=$(curl -s -w "%{http_code}" -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/user/packages/container/$PACKAGE_NAME/versions?per_page=100&page=$page")
            fi
            
            http_code=$(echo "$response" | tail -n1)
            versions=$(echo "$response" | sed '$ d')
            
            if [ "$http_code" != "200" ]; then
              echo "Error fetching versions for $PACKAGE_NAME: HTTP status $http_code"
              exit 1
            fi
            
            # Check if we got any data
            version_count=$(echo "$versions" | jq '. | length')
            if [ "$version_count" -eq 0 ]; then
              break
            fi
            
            all_versions="$all_versions$versions"
            page=$((page + 1))
          done
          
          if [ -z "$all_versions" ]; then
            echo "No versions found for $PACKAGE_NAME"
            exit 0
          fi
          
          # Find old versions to delete
          old_versions=$(echo "$all_versions" | jq -c --arg cutoff "$CUTOFF_DATE" '.[] | 
            select(.updated_at < $cutoff) | 
            select(.metadata.container.tags | length == 0 or (.metadata.container.tags | all(. != "latest" and . != "master" and . != "main")))')
          
          if [ -z "$old_versions" ]; then
            echo "No old versions to delete for $PACKAGE_NAME"
            exit 0
          fi
          
          # Process deletions
          package_deleted=0
          package_size_saved=0
          
          echo "$old_versions" | while IFS= read -r version; do
            version_id=$(echo "$version" | jq -r '.id')
            version_name=$(echo "$version" | jq -r '.name')
            version_size=$(echo "$version" | jq -r '.size // 0')
            version_tags=$(echo "$version" | jq -r '.metadata.container.tags // [] | join(", ")')
            updated_at=$(echo "$version" | jq -r '.updated_at')
            
            echo "  - Version: $version_name (ID: $version_id)"
            echo "    Updated: $updated_at"
            echo "    Size: $((version_size / 1024 / 1024)) MB"
            [ -n "$version_tags" ] && echo "    Tags: $version_tags"
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "    [DRY RUN] Would delete this version"
            else
              # Try org endpoint first, then user endpoint
              delete_response=$(curl -s -w "%{http_code}" -X DELETE \
                -H "Authorization: Bearer $GH_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME/versions/$version_id")
              
              delete_http_code=$(echo "$delete_response" | tail -n1)
              
              # If org endpoint fails with 404, try user endpoint
              if [ "$delete_http_code" = "404" ]; then
                delete_response=$(curl -s -w "%{http_code}" -X DELETE \
                  -H "Authorization: Bearer $GH_TOKEN" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/user/packages/container/$PACKAGE_NAME/versions/$version_id")
              fi
              
              delete_http_code=$(echo "$delete_response" | tail -n1)
              
              if [ "$delete_http_code" = "204" ]; then
                echo "    âœ“ Deleted successfully"
                package_deleted=$((package_deleted + 1))
                package_size_saved=$((package_size_saved + version_size))
              else
                echo "    âœ— Failed to delete (HTTP $delete_http_code)"
              fi
            fi
          done
          
          if [ "$DRY_RUN" != "true" ] && [ "${package_deleted:-0}" -gt 0 ]; then
            echo "  Deleted ${package_deleted:-0} versions from $PACKAGE_NAME, saved $((package_size_saved / 1024 / 1024)) MB"
            total_deleted=$((total_deleted + package_deleted))
            total_size_saved=$((total_size_saved + package_size_saved))
          fi
          
          # Summary
          echo ""
          echo "=========================================="
          echo "Cleanup Summary:"
          echo "Retention period: $RETENTION_DAYS days"
          echo "Cutoff date: $CUTOFF_DATE"
          if [ "$DRY_RUN" = "true" ]; then
            echo "Mode: DRY RUN (no deletions performed)"
          else
            echo "Total versions deleted: $total_deleted"
            echo "Total space freed: $((total_size_saved / 1024 / 1024)) MB"
          fi
          echo "=========================================="
      
      - name: Generate Job Summary
        if: always()
        env:
          RETENTION_DAYS: ${{ steps.config.outputs.retention_days }}
          DRY_RUN: ${{ steps.config.outputs.dry_run }}
        run: |
          {
            echo "# ðŸ§¹ Registry Cleanup Report"
            echo ""
            echo "**Package:** ghcr.io/${{ github.repository_owner }}/${{ env.SERVICE_NAME }}"
            echo "**Run Type:** ${{ github.event_name == 'schedule' && 'Scheduled' || 'Manual' }}"
            echo "**Retention Period:** $RETENTION_DAYS days"
            echo "**Mode:** ${{ env.DRY_RUN == 'true' && 'Dry Run' || 'Live' }}"
            echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          } >> "$GITHUB_STEP_SUMMARY"