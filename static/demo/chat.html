<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>go42 Chat Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-app {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 1200px;
            height: 95vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .app-header {
            background: #2c3e50;
            color: white;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-title {
            font-size: 20px;
            font-weight: 600;
        }

        .connection-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-connected { background: #2ecc71; color: white; }
        .status-disconnected { background: #e74c3c; color: white; }
        .status-connecting { background: #f39c12; color: white; }

        .app-body {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .auth-section {
            background: #f8f9fa;
            padding: 24px;
            min-width: 300px;
            max-width: 350px;
            border-right: 1px solid #e9ecef;
            display: flex;
            flex-direction: column;
            gap: 16px;
            overflow-y: auto;
        }

        .auth-section.hidden {
            display: none;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .rooms-section {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            min-height: 200px;
            max-height: 300px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0; /* Essential for flex child to shrink */
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            align-items: end;
        }

        label {
            font-weight: 500;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        button:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .rooms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .rooms-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .room-item {
            background: white;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: box-shadow 0.2s;
        }

        .room-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .room-info {
            flex: 1;
        }

        .room-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .room-meta {
            font-size: 12px;
            color: #7f8c8d;
            margin-top: 4px;
        }

        .current-room {
            background: #f8f9fa;
            padding: 16px;
            border-bottom: 1px solid #e9ecef;
            font-weight: 500;
            color: #2c3e50;
            flex-shrink: 0;
        }

        .messages-container {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            background: #fafafa;
            min-height: 0; /* Essential for flex child to shrink */
            max-height: 100%; /* Prevent infinite growth */
        }

        .message {
            background: white;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .message.system {
            border-left-color: #f39c12;
            background: #fdf6e3;
        }

        .message.join {
            border-left-color: #2ecc71;
            background: #eafaf1;
        }

        .message.leave {
            border-left-color: #e74c3c;
            background: #fdedec;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .message-user {
            font-weight: 600;
            color: #2c3e50;
        }

        .message-time {
            font-size: 12px;
            color: #7f8c8d;
        }

        .message-content {
            color: #34495e;
            line-height: 1.5;
        }

        .message-input-section {
            padding: 16px;
            background: white;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }

        .message-input-container {
            display: flex;
            gap: 12px;
        }

        .message-input {
            flex: 1;
        }

        .logs-section {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 16px;
            min-height: 120px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            border-top: 1px solid #34495e;
            flex-shrink: 0;
        }

        .log-entry {
            margin-bottom: 4px;
            padding: 4px 0;
        }

        .log-entry.info { color: #3498db; }
        .log-entry.success { color: #2ecc71; }
        .log-entry.error { color: #e74c3c; }
        .log-entry.warning { color: #f39c12; }

        .scroll-to-top {
            position: sticky;
            top: 0;
            right: 0;
            background: rgba(103, 126, 234, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 0 0 0 8px;
            font-size: 12px;
            cursor: pointer;
            z-index: 10;
            margin-left: auto;
            width: fit-content;
            backdrop-filter: blur(5px);
        }

        .scroll-to-top:hover {
            background: rgba(90, 111, 216, 0.9);
        }

        .rooms-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding: 4px 0;
            z-index: 5;
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 12px;
            padding-bottom: 6px;
            border-bottom: 2px solid #e9ecef;
        }

        .empty-state {
            text-align: center;
            color: #7f8c8d;
            padding: 24px;
            font-style: italic;
        }

        .auth-controls {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        @media (max-width: 1024px) {
            .chat-app {
                max-width: 95vw;
                height: 98vh;
            }
            
            .auth-section {
                min-width: 280px;
                max-width: 300px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .chat-app {
                height: 100vh;
                border-radius: 0;
            }
            
            .app-body {
                flex-direction: column;
            }
            
            .auth-section {
                min-width: auto;
                max-width: none;
                border-right: none;
                border-bottom: 1px solid #e9ecef;
                max-height: 40vh;
                flex-shrink: 0;
            }
            
            .rooms-section {
                min-height: 150px;
                max-height: 200px;
            }
            
            .rooms-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .form-row {
                flex-wrap: wrap;
            }
            
            .form-row input[type="number"] {
                width: 60px;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 12px 16px;
            }
            
            .app-title {
                font-size: 18px;
            }
            
            .auth-section {
                padding: 16px;
            }
            
            .rooms-section {
                padding: 12px;
            }
            
            .form-row {
                gap: 8px;
            }
            
            .form-row button {
                width: 100%;
                margin-top: 8px;
            }
            
            .room-item {
                padding: 8px;
            }
            
            .message {
                padding: 8px 12px;
            }
            
            .logs-section {
                min-height: 100px;
                max-height: 150px;
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="chat-app">
        <div class="app-header">
            <h1 class="app-title">go42 Chat Demo</h1>
            <div id="connectionStatus" class="connection-status status-disconnected">Disconnected</div>
        </div>

        <div class="app-body">
            <div id="authSection" class="auth-section">
                <div class="section-title">Authentication</div>
                
                <div class="form-group">
                    <label for="serverUrl">WebSocket URL</label>
                    <input type="text" id="serverUrl" value="ws://localhost:8080/ws/chat" placeholder="ws://localhost:8080/ws/chat">
                </div>

                <div class="form-group">
                    <label for="authToken">JWT Token</label>
                    <textarea id="authToken" rows="3" placeholder="Paste your JWT token here..."></textarea>
                </div>

                <div class="auth-controls">
                    <button id="connectBtn" onclick="connect()">Connect</button>
                    <button id="disconnectBtn" onclick="disconnect()" disabled class="btn-secondary">Disconnect</button>
                    <button onclick="showAuthInstructions()" class="btn-secondary">Get Token</button>
                </div>
            </div>

            <div class="main-content">
                <div class="rooms-section">
                    <div class="rooms-header">
                        <div class="section-title">Chat Rooms</div>
                        <button onclick="scrollToRooms()" class="scroll-to-top" title="Scroll to rooms">↑ Rooms</button>
                    </div>
                    <div class="rooms-grid">
                        <div>
                            <h4>Available Rooms</h4>
                            <div id="roomsList" class="rooms-list">
                                <div class="empty-state">Connect to see rooms</div>
                            </div>
                            <button onclick="refreshRooms()" disabled id="refreshBtn" class="btn-secondary" style="margin-top: 8px;">Refresh</button>
                        </div>
                        <div class="room-actions">
                            <h4>Room Actions</h4>
                            <div class="form-group">
                                <label for="roomName">Create Room</label>
                                <div class="form-row">
                                    <input type="text" id="roomName" placeholder="Room name" style="flex: 1;">
                                    <select id="roomType">
                                        <option value="public">Public</option>
                                        <option value="private">Private</option>
                                    </select>
                                    <input type="number" id="maxUsers" value="10" min="2" max="100" style="width: 80px;">
                                    <button onclick="createRoom()" disabled id="createRoomBtn">Create</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="joinRoomId">Join Room by ID</label>
                                <div class="form-row">
                                    <input type="text" id="joinRoomId" placeholder="Room ID" style="flex: 1;">
                                    <button onclick="joinRoom()" disabled id="joinRoomBtn">Join</button>
                                </div>
                            </div>
                            <button onclick="leaveRoom()" disabled id="leaveRoomBtn" class="btn-danger">Leave Current Room</button>
                        </div>
                    </div>
                </div>

                <div class="chat-section">
                    <div id="currentRoomInfo" class="current-room">Not in any room</div>
                    
                    <div id="messagesContainer" class="messages-container">
                        <div class="empty-state">Join a room to start chatting</div>
                    </div>

                    <div class="message-input-section">
                        <div class="message-input-container">
                            <input type="text" id="messageInput" class="message-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)" disabled>
                            <button onclick="sendChatMessage()" disabled id="sendMessageBtn">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="logs-section">
            <div class="section-title" style="color: #ecf0f1; border-bottom-color: #34495e;">Debug Logs</div>
            <div id="debugLog"></div>
        </div>
    </div>

    <script>
        class ChatApp {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.currentRoom = null;
                this.rooms = [];
                
                this.initializeElements();
                this.updateConnectionStatus('disconnected');
                this.log('Chat demo loaded. Please authenticate and connect to start chatting.', 'info');
            }

            initializeElements() {
                this.elements = {
                    connectionStatus: document.getElementById('connectionStatus'),
                    connectBtn: document.getElementById('connectBtn'),
                    disconnectBtn: document.getElementById('disconnectBtn'),
                    refreshBtn: document.getElementById('refreshBtn'),
                    createRoomBtn: document.getElementById('createRoomBtn'),
                    joinRoomBtn: document.getElementById('joinRoomBtn'),
                    leaveRoomBtn: document.getElementById('leaveRoomBtn'),
                    sendMessageBtn: document.getElementById('sendMessageBtn'),
                    messageInput: document.getElementById('messageInput'),
                    serverUrl: document.getElementById('serverUrl'),
                    authToken: document.getElementById('authToken'),
                    roomsList: document.getElementById('roomsList'),
                    currentRoomInfo: document.getElementById('currentRoomInfo'),
                    messagesContainer: document.getElementById('messagesContainer'),
                    debugLog: document.getElementById('debugLog'),
                    roomName: document.getElementById('roomName'),
                    roomType: document.getElementById('roomType'),
                    maxUsers: document.getElementById('maxUsers'),
                    joinRoomId: document.getElementById('joinRoomId')
                };
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${type}`;
                logEntry.textContent = `[${timestamp}] ${message}`;
                this.elements.debugLog.appendChild(logEntry);
                this.elements.debugLog.scrollTop = this.elements.debugLog.scrollHeight;
            }

            updateConnectionStatus(status) {
                this.elements.connectionStatus.className = `connection-status status-${status}`;
                this.elements.connectionStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                
                const isConnected = status === 'connected';
                const isConnecting = status === 'connecting';
                
                this.elements.connectBtn.disabled = isConnected || isConnecting;
                this.elements.disconnectBtn.disabled = !isConnected;
                this.elements.refreshBtn.disabled = !isConnected;
                this.elements.createRoomBtn.disabled = !isConnected;
                this.elements.joinRoomBtn.disabled = !isConnected;
                this.elements.leaveRoomBtn.disabled = !isConnected || !this.currentRoom;
                this.elements.sendMessageBtn.disabled = !isConnected || !this.currentRoom;
                this.elements.messageInput.disabled = !isConnected || !this.currentRoom;
            }

            connect() {
                const serverUrl = this.elements.serverUrl.value.trim();
                const token = this.elements.authToken.value.trim();
                
                if (!token) {
                    alert('Please enter a JWT token');
                    return;
                }
                
                this.updateConnectionStatus('connecting');
                this.log('Attempting to connect...', 'info');
                
                try {
                    const wsUrl = new URL(serverUrl);
                    wsUrl.searchParams.set('token', token);
                    this.ws = new WebSocket(wsUrl.toString());
                    
                    this.ws.onopen = () => {
                        this.isConnected = true;
                        this.updateConnectionStatus('connected');
                        this.log('Connected to chat server', 'success');
                        this.refreshRooms();
                    };
                    
                    this.ws.onmessage = (event) => {
                        try {
                            const data = JSON.parse(event.data);
                            this.handleMessage(data);
                        } catch (e) {
                            this.log('Failed to parse message: ' + event.data, 'error');
                        }
                    };
                    
                    this.ws.onclose = () => {
                        this.isConnected = false;
                        this.updateConnectionStatus('disconnected');
                        this.log('Disconnected from chat server', 'error');
                        this.currentRoom = null;
                        this.updateRoomInfo();
                    };
                    
                    this.ws.onerror = (error) => {
                        this.log('WebSocket error: ' + error, 'error');
                        this.updateConnectionStatus('disconnected');
                    };
                    
                } catch (error) {
                    this.log('Connection error: ' + error.message, 'error');
                    this.updateConnectionStatus('disconnected');
                }
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
            }

            sendMessage(type, data) {
                if (!this.isConnected || !this.ws) {
                    this.log('Not connected to server', 'error');
                    return;
                }
                
                const message = { type, data };
                this.ws.send(JSON.stringify(message));
                this.log('Sent: ' + JSON.stringify(message), 'info');
            }

            handleMessage(message) {
                this.log('Received: ' + JSON.stringify(message), 'info');
                
                // Handle chat messages (domain.Message objects with id field) first
                if (message.id) {
                    this.displayChatMessage(message);
                }
                // Handle WebSocket control messages (type-based)
                else if (message.type) {
                    switch (message.type) {
                        case 'room_created':
                            this.log('Room created: ' + message.data.name, 'success');
                            this.refreshRooms();
                            break;
                        case 'rooms_list':
                            this.displayRooms(message.data);
                            break;
                        case 'error':
                            this.log('Server error: ' + message.data.message, 'error');
                            break;
                        default:
                            this.log('Unknown message type: ' + message.type, 'warning');
                    }
                }
            }

            displayChatMessage(message) {
                const container = this.elements.messagesContainer;
                
                // Clear empty state if present
                if (container.querySelector('.empty-state')) {
                    container.innerHTML = '';
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.type}`;
                
                const header = document.createElement('div');
                header.className = 'message-header';
                
                const userSpan = document.createElement('span');
                userSpan.className = 'message-user';
                userSpan.textContent = message.user.username || message.user.uuid;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'message-time';
                timeSpan.textContent = new Date(message.timestamp).toLocaleTimeString();
                
                header.appendChild(userSpan);
                header.appendChild(timeSpan);
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.textContent = message.content;
                
                messageElement.appendChild(header);
                messageElement.appendChild(content);
                container.appendChild(messageElement);
                container.scrollTop = container.scrollHeight;
            }

            displayRooms(rooms) {
                this.rooms = rooms || [];
                const container = this.elements.roomsList;
                container.innerHTML = '';
                
                if (!rooms || rooms.length === 0) {
                    container.innerHTML = '<div class="empty-state">No rooms available</div>';
                    return;
                }
                
                rooms.forEach(room => {
                    const roomElement = document.createElement('div');
                    roomElement.className = 'room-item';
                    
                    const roomInfo = document.createElement('div');
                    roomInfo.className = 'room-info';
                    
                    const roomName = document.createElement('div');
                    roomName.className = 'room-name';
                    roomName.textContent = room.name;
                    
                    const roomMeta = document.createElement('div');
                    roomMeta.className = 'room-meta';
                    roomMeta.textContent = `${room.type} • ${room.user_count}/${room.max_users} users • ${room.id}`;
                    
                    roomInfo.appendChild(roomName);
                    roomInfo.appendChild(roomMeta);
                    
                    const joinBtn = document.createElement('button');
                    joinBtn.textContent = 'Join';
                    joinBtn.onclick = () => this.joinRoomById(room.id);
                    
                    roomElement.appendChild(roomInfo);
                    roomElement.appendChild(joinBtn);
                    container.appendChild(roomElement);
                });
            }

            refreshRooms() {
                this.sendMessage('list_rooms', {});
            }

            createRoom() {
                const name = this.elements.roomName.value.trim();
                const type = this.elements.roomType.value;
                const maxUsers = parseInt(this.elements.maxUsers.value);
                
                if (!name) {
                    alert('Please enter a room name');
                    return;
                }
                
                this.sendMessage('create_room', {
                    name: name,
                    type: type,
                    max_users: maxUsers
                });
                
                this.elements.roomName.value = '';
            }

            joinRoom() {
                const roomId = this.elements.joinRoomId.value.trim();
                if (!roomId) {
                    alert('Please enter a room ID');
                    return;
                }
                this.joinRoomById(roomId);
            }

            joinRoomById(roomId) {
                this.sendMessage('join_room', { room_id: roomId });
                this.currentRoom = roomId;
                this.updateRoomInfo();
                this.elements.joinRoomId.value = '';
                this.elements.messagesContainer.innerHTML = '<div class="empty-state">Loading messages...</div>';
                this.updateConnectionStatus('connected'); // Refresh button states
            }

            leaveRoom() {
                if (!this.currentRoom) {
                    alert('Not in any room');
                    return;
                }
                
                this.sendMessage('leave_room', {});
                this.currentRoom = null;
                this.updateRoomInfo();
                this.elements.messagesContainer.innerHTML = '<div class="empty-state">Join a room to start chatting</div>';
                this.updateConnectionStatus('connected'); // Refresh button states
            }

            updateRoomInfo() {
                if (this.currentRoom) {
                    this.elements.currentRoomInfo.textContent = `Current Room: ${this.currentRoom}`;
                } else {
                    this.elements.currentRoomInfo.textContent = 'Not in any room';
                }
            }

            sendChatMessage() {
                const input = this.elements.messageInput;
                const content = input.value.trim();
                
                if (!content) {
                    return;
                }
                
                if (!this.currentRoom) {
                    alert('Please join a room first');
                    return;
                }
                
                this.sendMessage('send_message', {
                    type: 'text',
                    content: content,
                    room_id: this.currentRoom
                });
                
                input.value = '';
            }

            handleKeyPress(event) {
                if (event.key === 'Enter') {
                    this.sendChatMessage();
                }
            }

            showAuthInstructions() {
                const instructions = `To get a JWT token for testing:

1. Create a user account:
curl -X POST http://localhost:8080/api/v1/auth/signup \\
  -H "Content-Type: application/json" \\
  -d '{"email": "test@example.com", "password": "testpassword123"}'

2. Login to get a token:
curl -X POST http://localhost:8080/api/v1/auth/login \\
  -H "Content-Type: application/json" \\
  -d '{"email": "test@example.com", "password": "testpassword123"}'

3. Copy the access_token from the response and paste it in the JWT Token field above.

Note: The password must be at least 8 characters long with good entropy.`;
                
                alert(instructions);
            }
        }

        // Global instances and functions for backward compatibility
        let chatApp;
        
        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            chatApp = new ChatApp();
        });

        // Global functions called by HTML elements
        function connect() { chatApp.connect(); }
        function disconnect() { chatApp.disconnect(); }
        function refreshRooms() { chatApp.refreshRooms(); }
        function createRoom() { chatApp.createRoom(); }
        function joinRoom() { chatApp.joinRoom(); }
        function leaveRoom() { chatApp.leaveRoom(); }
        function sendChatMessage() { chatApp.sendChatMessage(); }
        function handleKeyPress(event) { chatApp.handleKeyPress(event); }
        function showAuthInstructions() { chatApp.showAuthInstructions(); }
        function scrollToRooms() {
            const roomsSection = document.querySelector('.rooms-section');
            roomsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    </script>
</body>
</html>